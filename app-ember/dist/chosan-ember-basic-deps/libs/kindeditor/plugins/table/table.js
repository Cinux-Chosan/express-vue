KindEditor.plugin("table",function(e){var l=this,t="table",o=l.lang("table.")
function n(e,l){l=l.toUpperCase(),e.css("background-color",l),e.css("color","#000000"===l?"#FFFFFF":"#000000"),e.html(l)}var a=[]
function i(t,o){function i(){e.each(a,function(){this.remove()}),a=[],e(document).unbind("click,mousedown",i),t.unbind("click,mousedown",i)}o.bind("click,mousedown",function(e){e.stopPropagation()}),o.click(function(o){i()
var r=e(this),d=r.pos(),c=e.colorpicker({x:d.x,y:d.y+r.height(),z:811214,selectedColor:e(this).html(),colors:l.colorTable,noColor:l.lang("noColor"),shadowMode:l.shadowMode,click:function(e){n(r,e),i()}})
a.push(c),e(document).bind("click,mousedown",i),t.bind("click,mousedown",i)})}function r(e,l,t){for(var o=0,n=0,a=l.cells.length;n<a&&l.cells[n]!=t;n++)o+=l.cells[n].rowSpan-1
return t.cellIndex-o}l.plugin.table={prop:function(a){var r,d=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keRows" style="width:90px;">'+o.cells+"</label>",o.rows+' <input type="text" id="keRows" class="ke-input-text ke-input-number" name="rows" value="" maxlength="4" /> &nbsp; ',o.cols+' <input type="text" class="ke-input-text ke-input-number" name="cols" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+o.size+"</label>",o.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+o.percent+"</option>",'<option value="px">'+o.px+"</option>","</select> &nbsp; ",o.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+o.percent+"</option>",'<option value="px">'+o.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="kePadding" style="width:90px;">'+o.space+"</label>",o.padding+' <input type="text" id="kePadding" class="ke-input-text ke-input-number" name="padding" value="" maxlength="4" /> &nbsp; ',o.spacing+' <input type="text" class="ke-input-text ke-input-number" name="spacing" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+o.align+"</label>",'<select id="keAlign" name="align">','<option value="">'+o.alignDefault+"</option>",'<option value="left">'+o.alignLeft+"</option>",'<option value="center">'+o.alignCenter+"</option>",'<option value="right">'+o.alignRight+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+o.border+"</label>",o.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',o.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+o.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),c=l.cmd.range.createBookmark(),s=l.createDialog({name:t,width:500,title:l.lang(t),body:d,beforeRemove:function(){x.unbind()},yesBtn:{name:l.lang("yes"),click:function(t){var o=p.val(),n=g.val(),a=v.val(),i=u.val(),d=m.val(),s=h.val(),S=b.val(),y=k.val(),C=w.val(),B=f.val(),T=e(x[0]).html()||"",A=e(x[1]).html()||""
if(0==o||!/^\d+$/.test(o))return alert(l.lang("invalidRows")),void p[0].focus()
if(0==n||!/^\d+$/.test(n))return alert(l.lang("invalidRows")),void g[0].focus()
if(!/^\d*$/.test(a))return alert(l.lang("invalidWidth")),void v[0].focus()
if(!/^\d*$/.test(i))return alert(l.lang("invalidHeight")),void u[0].focus()
if(!/^\d*$/.test(S))return alert(l.lang("invalidPadding")),void b[0].focus()
if(!/^\d*$/.test(y))return alert(l.lang("invalidSpacing")),void k[0].focus()
if(!/^\d*$/.test(B))return alert(l.lang("invalidBorder")),void f[0].focus()
if(r)return""!==a?r.width(a+d):r.css("width",""),void 0!==r[0].width&&r.removeAttr("width"),""!==i?r.height(i+s):r.css("height",""),void 0!==r[0].height&&r.removeAttr("height"),r.css("background-color",A),void 0!==r[0].bgColor&&r.removeAttr("bgColor"),""!==S?r[0].cellPadding=S:r.removeAttr("cellPadding"),""!==y?r[0].cellSpacing=y:r.removeAttr("cellSpacing"),""!==C?r[0].align=C:r.removeAttr("align"),""!==B?r.attr("border",B):r.removeAttr("border"),""===B||"0"===B?r.addClass("ke-zeroborder"):r.removeClass("ke-zeroborder"),""!==T?r.attr("borderColor",T):r.removeAttr("borderColor"),l.hideDialog().focus(),l.cmd.range.moveToBookmark(c),l.cmd.select(),void l.addBookmark()
var I=""
""!==a&&(I+="width:"+a+d+";"),""!==i&&(I+="height:"+i+s+";"),""!==A&&(I+="background-color:"+A+";")
var R="<table"
""!==I&&(R+=' style="'+I+'"'),""!==S&&(R+=' cellpadding="'+S+'"'),""!==y&&(R+=' cellspacing="'+y+'"'),""!==C&&(R+=' align="'+C+'"'),""!==B&&(R+=' border="'+B+'"'),""!==B&&"0"!==B||(R+=' class="ke-zeroborder"'),""!==T&&(R+=' bordercolor="'+T+'"'),R+=">"
for(var $=0;$<o;$++){R+="<tr>"
for(var q=0;q<n;q++)R+="<td>"+(e.IE?"&nbsp;":"<br />")+"</td>"
R+="</tr>"}R+="</table>",e.IE||(R+="<br />"),l.insertHtml(R),l.select().hideDialog().focus(),l.addBookmark()}}}).div,p=e('[name="rows"]',s).val(3),g=e('[name="cols"]',s).val(2),v=e('[name="width"]',s).val(100),u=e('[name="height"]',s),m=e('[name="widthType"]',s),h=e('[name="heightType"]',s),b=e('[name="padding"]',s).val(2),k=e('[name="spacing"]',s).val(0),w=e('[name="align"]',s),f=e('[name="border"]',s).val(1),x=e(".ke-input-color",s)
if(i(s,x.eq(0)),i(s,x.eq(1)),n(x.eq(0),"#000000"),n(x.eq(1),""),p[0].focus(),p[0].select(),!a&&(r=l.plugin.getSelectedTable())){p.val(r[0].rows.length),g.val(r[0].rows.length>0?r[0].rows[0].cells.length:0),p.attr("disabled",!0),g.attr("disabled",!0)
var S,y=r[0].style.width||r[0].width,C=r[0].style.height||r[0].height
void 0!==y&&(S=/^(\d+)((?:px|%)*)$/.exec(y))?(v.val(S[1]),m.val(S[2])):v.val(""),void 0!==C&&(S=/^(\d+)((?:px|%)*)$/.exec(C))&&(u.val(S[1]),h.val(S[2])),b.val(r[0].cellPadding||""),k.val(r[0].cellSpacing||""),w.val(r[0].align||""),f.val(void 0===r[0].border?"":r[0].border),n(x.eq(0),e.toHex(r.attr("borderColor")||"")),n(x.eq(1),e.toHex(r[0].style.backgroundColor||r[0].bgColor||"")),v[0].focus(),v[0].select()}},cellprop:function(){var a=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+o.size+"</label>",o.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+o.percent+"</option>",'<option value="px">'+o.px+"</option>","</select> &nbsp; ",o.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+o.percent+"</option>",'<option value="px">'+o.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+o.align+"</label>",o.textAlign+' <select id="keAlign" name="textAlign">','<option value="">'+o.alignDefault+"</option>",'<option value="left">'+o.alignLeft+"</option>",'<option value="center">'+o.alignCenter+"</option>",'<option value="right">'+o.alignRight+"</option>","</select> ",o.verticalAlign+' <select name="verticalAlign">','<option value="">'+o.alignDefault+"</option>",'<option value="top">'+o.alignTop+"</option>",'<option value="middle">'+o.alignMiddle+"</option>",'<option value="bottom">'+o.alignBottom+"</option>",'<option value="baseline">'+o.alignBaseline+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+o.border+"</label>",o.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',o.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+o.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),r=l.cmd.range.createBookmark(),d=l.createDialog({name:t,width:500,title:l.lang("tablecell"),body:a,beforeRemove:function(){k.unbind()},yesBtn:{name:l.lang("yes"),click:function(t){var o=c.val(),n=s.val(),a=p.val(),i=g.val(),d=(v.val(),u.val(),m.val()),w=h.val(),x=b.val(),S=e(k[0]).html()||"",y=e(k[1]).html()||""
return/^\d*$/.test(o)?/^\d*$/.test(n)?/^\d*$/.test(x)?(f.css({width:""!==o?o+a:"",height:""!==n?n+i:"","background-color":y,"text-align":d,"vertical-align":w,"border-width":x,"border-style":""!==x?"solid":"","border-color":S}),l.hideDialog().focus(),l.cmd.range.moveToBookmark(r),l.cmd.select(),void l.addBookmark()):(alert(l.lang("invalidBorder")),void b[0].focus()):(alert(l.lang("invalidHeight")),void s[0].focus()):(alert(l.lang("invalidWidth")),void c[0].focus())}}}).div,c=e('[name="width"]',d).val(100),s=e('[name="height"]',d),p=e('[name="widthType"]',d),g=e('[name="heightType"]',d),v=e('[name="padding"]',d).val(2),u=e('[name="spacing"]',d).val(0),m=e('[name="textAlign"]',d),h=e('[name="verticalAlign"]',d),b=e('[name="border"]',d).val(1),k=e(".ke-input-color",d)
i(d,k.eq(0)),i(d,k.eq(1)),n(k.eq(0),"#000000"),n(k.eq(1),""),c[0].focus(),c[0].select()
var w,f=l.plugin.getSelectedCell(),x=f[0].style.width||f[0].width||"",S=f[0].style.height||f[0].height||"";(w=/^(\d+)((?:px|%)*)$/.exec(x))?(c.val(w[1]),p.val(w[2])):c.val(""),(w=/^(\d+)((?:px|%)*)$/.exec(S))&&(s.val(w[1]),g.val(w[2])),m.val(f[0].style.textAlign||""),h.val(f[0].style.verticalAlign||"")
var y=f[0].style.borderWidth||""
y&&(y=parseInt(y)),b.val(y),n(k.eq(0),e.toHex(f[0].style.borderColor||"")),n(k.eq(1),e.toHex(f[0].style.backgroundColor||"")),c[0].focus(),c[0].select()},insert:function(){this.prop(!0)},delete:function(){var e=l.plugin.getSelectedTable()
l.cmd.range.setStartBefore(e[0]).collapse(!0),l.cmd.select(),e.remove(),l.addBookmark()},colinsert:function(t){var o=l.plugin.getSelectedTable()[0],n=l.plugin.getSelectedRow()[0],a=l.plugin.getSelectedCell()[0],i=a.cellIndex+t
i+=o.rows[0].cells.length-n.cells.length
for(var d=0,c=o.rows.length;d<c;d++){var s=o.rows[d],p=s.insertCell(i)
p.innerHTML=e.IE?"":"<br />",i=r(0,s,p)}l.cmd.range.selectNodeContents(a).collapse(!0),l.cmd.select(),l.addBookmark()},colinsertleft:function(){this.colinsert(0)},colinsertright:function(){this.colinsert(1)},rowinsert:function(t){var o=l.plugin.getSelectedTable()[0],n=l.plugin.getSelectedRow()[0],a=l.plugin.getSelectedCell()[0],i=n.rowIndex
1===t&&(i=n.rowIndex+(a.rowSpan-1)+t)
for(var r=o.insertRow(i),d=0,c=n.cells.length;d<c;d++){n.cells[d].rowSpan>1&&(c-=n.cells[d].rowSpan-1)
var s=r.insertCell(d)
1===t&&n.cells[d].colSpan>1&&(s.colSpan=n.cells[d].colSpan),s.innerHTML=e.IE?"":"<br />"}for(var p=i;p>=0;p--){var g=o.rows[p].cells
if(g.length>d){for(var v=a.cellIndex;v>=0;v--)g[v].rowSpan>1&&(g[v].rowSpan+=1)
break}}l.cmd.range.selectNodeContents(a).collapse(!0),l.cmd.select(),l.addBookmark()},rowinsertabove:function(){this.rowinsert(0)},rowinsertbelow:function(){this.rowinsert(1)},rowmerge:function(){var e=l.plugin.getSelectedTable()[0],t=l.plugin.getSelectedRow()[0],o=l.plugin.getSelectedCell()[0],n=t.rowIndex+o.rowSpan,a=e.rows[n]
if(!(e.rows.length<=n)){var i=o.cellIndex
if(!(a.cells.length<=i)){var r=a.cells[i]
o.colSpan===r.colSpan&&(o.rowSpan+=r.rowSpan,a.deleteCell(i),l.cmd.range.selectNodeContents(o).collapse(!0),l.cmd.select(),l.addBookmark())}}},colmerge:function(){l.plugin.getSelectedTable()[0]
var e=l.plugin.getSelectedRow()[0],t=l.plugin.getSelectedCell()[0],o=(e.rowIndex,t.cellIndex+1)
if(!(e.cells.length<=o)){var n=e.cells[o]
t.rowSpan===n.rowSpan&&(t.colSpan+=n.colSpan,e.deleteCell(o),l.cmd.range.selectNodeContents(t).collapse(!0),l.cmd.select(),l.addBookmark())}},rowsplit:function(){var t=l.plugin.getSelectedTable()[0],o=l.plugin.getSelectedRow()[0],n=l.plugin.getSelectedCell()[0],a=o.rowIndex
if(1!==n.rowSpan){for(var i=r(0,o,n),d=1,c=n.rowSpan;d<c;d++){var s=t.rows[a+d],p=s.insertCell(i)
n.colSpan>1&&(p.colSpan=n.colSpan),p.innerHTML=e.IE?"":"<br />",i=r(0,s,p)}e(n).removeAttr("rowSpan"),l.cmd.range.selectNodeContents(n).collapse(!0),l.cmd.select(),l.addBookmark()}},colsplit:function(){l.plugin.getSelectedTable()[0]
var t=l.plugin.getSelectedRow()[0],o=l.plugin.getSelectedCell()[0],n=o.cellIndex
if(1!==o.colSpan){for(var a=1,i=o.colSpan;a<i;a++){var r=t.insertCell(n+a)
o.rowSpan>1&&(r.rowSpan=o.rowSpan),r.innerHTML=e.IE?"":"<br />"}e(o).removeAttr("colSpan"),l.cmd.range.selectNodeContents(o).collapse(!0),l.cmd.select(),l.addBookmark()}},coldelete:function(){for(var t=l.plugin.getSelectedTable()[0],o=l.plugin.getSelectedRow()[0],n=l.plugin.getSelectedCell()[0].cellIndex,a=0,i=t.rows.length;a<i;a++){var r=t.rows[a],d=r.cells[n]
d.colSpan>1?(d.colSpan-=1,1===d.colSpan&&e(d).removeAttr("colSpan")):r.deleteCell(n),d.rowSpan>1&&(a+=d.rowSpan-1)}0===o.cells.length?(l.cmd.range.setStartBefore(t).collapse(!0),l.cmd.select(),e(t).remove()):l.cmd.selection(!0),l.addBookmark()},rowdelete:function(){for(var t=l.plugin.getSelectedTable()[0],o=l.plugin.getSelectedRow()[0],n=l.plugin.getSelectedCell()[0],a=o.rowIndex,i=n.rowSpan-1;i>=0;i--)t.deleteRow(a+i)
0===t.rows.length?(l.cmd.range.setStartBefore(t).collapse(!0),l.cmd.select(),e(t).remove()):l.cmd.selection(!0),l.addBookmark()}},l.clickToolbar(t,l.plugin.table.prop)})
