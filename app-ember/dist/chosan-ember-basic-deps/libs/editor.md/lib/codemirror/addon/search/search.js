(function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror)})(function(e){"use strict"
function o(){this.posFrom=this.posTo=this.query=null,this.overlay=null}function r(e){return e.state.search||(e.state.search=new o)}function n(e){return"string"==typeof e&&e==e.toLowerCase()}function t(e,o,r){return e.getSearchCursor(o,r,n(o))}function i(e,o,r,n,t){e.openDialog?e.openDialog(o,t,{value:n}):t(prompt(r,n))}function a(e){var o=e.match(/^\/(.*)\/([a-z]*)$/)
if(o)try{e=new RegExp(o[1],-1==o[2].indexOf("i")?"":"i")}catch(e){}return("string"==typeof e?""==e:e.test(""))&&(e=/x^/),e}var c='Search: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>'
function s(e,o){var t=r(e)
if(t.query)return l(e,o)
i(e,c,"Search for:",e.getSelection(),function(r){e.operation(function(){r&&!t.query&&(t.query=a(r),e.removeOverlay(t.overlay,n(t.query)),t.overlay=function(e,o){return"string"==typeof e?e=new RegExp(e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),o?"gi":"g"):e.global||(e=new RegExp(e.source,e.ignoreCase?"gi":"g")),{token:function(o){e.lastIndex=o.pos
var r=e.exec(o.string)
if(r&&r.index==o.pos)return o.pos+=r[0].length,"searching"
r?o.pos=r.index:o.skipToEnd()}}}(t.query,n(t.query)),e.addOverlay(t.overlay),e.showMatchesOnScrollbar&&(t.annotate&&(t.annotate.clear(),t.annotate=null),t.annotate=e.showMatchesOnScrollbar(t.query,n(t.query))),t.posFrom=t.posTo=e.getCursor(),l(e,o))})})}function l(o,n){o.operation(function(){var i=r(o),a=t(o,i.query,n?i.posFrom:i.posTo);(a.find(n)||(a=t(o,i.query,n?e.Pos(o.lastLine()):e.Pos(o.firstLine(),0))).find(n))&&(o.setSelection(a.from(),a.to()),o.scrollIntoView({from:a.from(),to:a.to()}),i.posFrom=a.from(),i.posTo=a.to())})}function u(e){e.operation(function(){var o=r(e)
o.query&&(o.query=null,e.removeOverlay(o.overlay),o.annotate&&(o.annotate.clear(),o.annotate=null))})}var f='Replace: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',p='With: <input type="text" style="width: 10em" class="CodeMirror-search-field"/>',d="Replace? <button>Yes</button> <button>No</button> <button>Stop</button>"
function m(e,o){e.getOption("readOnly")||i(e,f,"Replace:",e.getSelection(),function(r){r&&(r=a(r),i(e,p,"Replace with:","",function(n){if(o)e.operation(function(){for(var o=t(e,r);o.findNext();)if("string"!=typeof r){var i=e.getRange(o.from(),o.to()).match(r)
o.replace(n.replace(/\$(\d)/g,function(e,o){return i[o]}))}else o.replace(n)})
else{u(e)
var i=t(e,r,e.getCursor()),a=function(){var o,n=i.from()
!(o=i.findNext())&&(i=t(e,r),!(o=i.findNext())||n&&i.from().line==n.line&&i.from().ch==n.ch)||(e.setSelection(i.from(),i.to()),e.scrollIntoView({from:i.from(),to:i.to()}),function(e,o,r,n){e.openConfirm?e.openConfirm(o,n):confirm(r)&&n[0]()}(e,d,"Replace?",[function(){c(o)},a]))},c=function(e){i.replace("string"==typeof r?n:n.replace(/\$(\d)/g,function(o,r){return e[r]})),a()}
a()}}))})}e.commands.find=function(e){u(e),s(e)},e.commands.findNext=s,e.commands.findPrev=function(e){s(e,!0)},e.commands.clearSearch=u,e.commands.replace=m,e.commands.replaceAll=function(e){m(e,!0)}})
